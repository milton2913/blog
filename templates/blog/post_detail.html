{% extends 'base.html' %}
{% load blog_extras %}

{% block title %}{{ post.meta_title|default:post.title }} | {{ theme.site_name }}{% endblock %}

{% block meta_description %}{{ post.meta_description|default:post.content|truncatewords:20 }}{% endblock %}
{% block meta_keywords %}{{ post.meta_keywords|default:theme.site_keywords }}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ post.meta_title|default:post.title }}{% endblock %}
{% block og_description %}{{ post.meta_description|default:post.content|truncatewords:20 }}{% endblock %}
{% block og_image %}
{% if post.featured_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}">
{% endif %}
{% endblock %}

{% block twitter_title %}{{ post.meta_title|default:post.title }}{% endblock %}
{% block twitter_description %}{{ post.meta_description|default:post.content|truncatewords:20 }}{% endblock %}
{% block twitter_image %}
{% if post.featured_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}">
{% endif %}
{% endblock %}

{% block content %}

<section class="w-full md:w-2/3 flex flex-col items-center px-3">

    <article class="glass-card rounded-2xl overflow-hidden shadow-lg w-full mb-8">
        <!-- Article Image -->
        {% if post.featured_image %}
        <div class="w-full h-80 md:h-[500px] overflow-hidden relative">
            <img src="{{ post.featured_image.url }}" class="w-full h-full object-cover shadow-inner">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900/50 to-transparent"></div>
        </div>
        {% else %}
        <div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-400">
            <i class="fas fa-image text-4xl"></i>
        </div>
        {% endif %}

        <div class="bg-white/80 backdrop-blur-md p-8 md:p-12">
            <div class="flex items-center gap-3 mb-6">
                <a href="{% url 'blog:category_list' post.category.slug %}"
                    class="text-xs font-bold uppercase tracking-wider text-primary bg-blue-100 px-3 py-1 rounded-full hover:bg-blue-200 transition">
                    {{ post.category.name }}
                </a>
                <span class="text-sm text-gray-500 flex items-center gap-1">
                    <i class="far fa-calendar-alt"></i> {{ post.published_at|date:"F d, Y" }}
                </span>
                <span class="text-sm text-gray-500 flex items-center gap-1 ml-auto">
                    <i class="far fa-clock"></i> {{ post.content|wordcount|divisibleby:200 }} min read
                </span>
            </div>

            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6 leading-tight">
                {{ post.title }}
            </h1>

            <div class="flex items-center gap-3 mb-8">
                {% if post.author.profile_image %}
                <img src="{{ post.author.profile_image.url }}" alt="{{ post.author.username }}"
                    class="w-12 h-12 rounded-full object-cover shadow-md">
                {% else %}
                <div
                    class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center text-lg font-bold shadow-md">
                    {{ post.author.username|slice:":1"|upper }}
                </div>
                {% endif %}
                <p class="text-lg text-gray-600">
                    By
                    <a href="#" class="font-bold text-gray-800 hover:text-primary transition">
                        {{ post.author.username }}
                    </a>
                </p>
            </div>

            <!-- Post Content with Typography Plugin styling -->
            <div class="prose prose-lg prose-blue max-w-none text-gray-800 leading-relaxed font-serif break-words">
                {{ post.content|linebreaks }}
            </div>

            <div class="mt-12 pt-8 border-t border-gray-200">
                <p class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-tags text-primary"></i>
                    Tags:
                </p>
                <div class="flex flex-wrap gap-2">
                    {% for tag in post.tags.all %}
                    <a href="{% url 'blog:tag_list' tag.slug %}"
                        class="px-4 py-2 bg-gray-100 text-sm font-semibold text-gray-700 rounded-lg hover:bg-primary hover:text-white transition shadow-sm">
                        #{{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </article>

    <!-- Author Bio -->
    <div
        class="glass-card w-full flex flex-col md:flex-row shadow-lg rounded-2xl p-8 mb-8 items-center md:items-start text-center md:text-left">
        {% if post.author.profile_image %}
        <img src="{{ post.author.profile_image.url }}" alt="{{ post.author.username }}"
            class="w-24 h-24 rounded-full object-cover mb-4 md:mb-0 md:mr-6 shadow-md flex-shrink-0">
        {% else %}
        <div
            class="w-24 h-24 rounded-full bg-primary text-white flex items-center justify-center text-3xl font-bold mb-4 md:mb-0 md:mr-6 shadow-md flex-shrink-0">
            {{ post.author.username|slice:":1"|upper }}
        </div>
        {% endif %}
        <div class="flex-1">
            <p class="font-bold text-2xl text-gray-800 mb-2">{{ post.author.username }}</p>
            <p class="text-gray-600 mb-4 text-sm leading-relaxed">
                {{ post.author.bio|default:"Passionate writer and developer sharing insights on technology." }}

            </p>

            <div class="flex justify-center md:justify-start gap-4 text-xl">
                {% if post.author.facebook_url %}
                <a href="{{ post.author.facebook_url }}" target="_blank" rel="noopener"
                    class="text-gray-400 hover:text-blue-600 transition transform hover:scale-110"><i
                        class="fab fa-facebook"></i></a>
                {% endif %}
                {% if post.author.twitter_url %}
                <a href="{{ post.author.twitter_url }}" target="_blank" rel="noopener"
                    class="text-gray-400 hover:text-blue-400 transition transform hover:scale-110"><i
                        class="fab fa-twitter"></i></a>
                {% endif %}
                {% if post.author.instagram_url %}
                <a href="{{ post.author.instagram_url }}" target="_blank" rel="noopener"
                    class="text-gray-400 hover:text-pink-600 transition transform hover:scale-110"><i
                        class="fab fa-instagram"></i></a>
                {% endif %}
                {% if post.author.linkedin_url %}
                <a href="{{ post.author.linkedin_url }}" target="_blank" rel="noopener"
                    class="text-gray-400 hover:text-blue-700 transition transform hover:scale-110"><i
                        class="fab fa-linkedin"></i></a>
                {% endif %}
                {% if post.author.github_url %}
                <a href="{{ post.author.github_url }}" target="_blank" rel="noopener"
                    class="text-gray-400 hover:text-gray-900 transition transform hover:scale-110"><i
                        class="fab fa-github"></i></a>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- Related Posts -->
    {% if related_posts %}
    <div class="glass-card w-full shadow-lg rounded-2xl p-8 mb-12">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b border-gray-100 pb-4">Related Posts</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% for rpost in related_posts %}
            <a href="{% url 'blog:post_detail' rpost.slug %}"
                class="group flex flex-col hover:bg-gray-50 p-4 rounded-xl transition">
                <div class="h-40 bg-gray-200 rounded-lg overflow-hidden mb-3 relative shadow-sm">
                    {% if rpost.featured_image %}
                    <img src="{{ rpost.featured_image.url }}"
                        class="w-full h-full object-cover transform group-hover:scale-110 transition duration-500">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-100">
                        <i class="fas fa-image text-3xl"></i>
                    </div>
                    {% endif %}
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition"></div>
                </div>
                <span class="font-bold text-gray-800 group-hover:text-primary transition line-clamp-2 leading-snug">
                    {{ rpost.title }}
                </span>
                <span class="text-xs text-gray-500 mt-2">{{ rpost.published_at|date:"M d" }}</span>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Comments Section -->
    <div class="w-full mt-8" x-data="{
            async submitForm(e) {
                const form = e.target;
                const formData = new FormData(form);
                formData.append('ajax', '1');
                
                try {
                    const response = await fetch(form.action || window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    
                    if (response.ok) {
                        const html = await response.text();
                        // Update comments list
                        document.querySelector('.comments-list').innerHTML = html;
                        // Reset form if it's the main one
                        if (!form.querySelector('input[name=parent_id]')) {
                             form.reset();
                        } else {
                            // Hide reply form
                            form.closest('[id^=reply-form-]').classList.add('hidden');
                        }
                    } else {
                        console.error('Submission failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
         }" x-on:submit.prevent="submitForm($event)">

        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <i class="fas fa-comments text-primary"></i> Comments ({{ post.comments.count }})
        </h3>

        <!-- Main Comment Form -->
        <div class="glass-card w-full shadow-lg rounded-2xl p-8 mb-12">
            <h4 class="text-lg font-bold text-gray-800 mb-4">Leave a Comment</h4>
            <form method="post">
                {% csrf_token %}

                <div class="grid grid-cols-1 gap-4">
                    {% if not user.is_authenticated %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>{{ comment_form.name }}</div>
                        <div>{{ comment_form.email }}</div>
                    </div>
                    {% else %}
                    <input type="hidden" name="name" value="{{ user.get_full_name|default:user.username }}">
                    <input type="hidden" name="email" value="{{ user.email }}">
                    {% endif %}
                    <div>{{ comment_form.body }}</div>
                </div>

                <button type="submit"
                    class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg transform hover:scale-105">
                    Post Comment
                </button>
            </form>
        </div>

        <!-- Comments List -->
        <div class="comments-list w-full">
            {% include "blog/comments.html" %}
        </div>
    </div>
</section>

<script>
    function toggleReplyForm(commentId) {
        const form = document.getElementById(`reply-form-${commentId}`);
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
        } else {
            form.classList.add('hidden');
        }
    }
</script>

{% show_sidebar %}

{% endblock %}